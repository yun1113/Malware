#code for python3.x
import simplejson #simplejson should be installed first
import urllib #
import urllib2  #urllib2 merged into urllib in pyhton3
import json
import sys

def getApi(hash):
    url = "https://www.virustotal.com/vtapi/v2/file/report"
    parameters = {"resource": hash, "apikey": "92b3ab3619912133954ace582818162e4f0bba82cd2a994c7c894ef9f52bf9a5"}
    print(parameters)
    data = urllib.urlencode(parameters)
    binary_data = data.encode("utf8")
    
    req = urllib2.Request(url, binary_data)
    response = urllib2.urlopen(req)
    json = response.read()
    # print(json)

    with open('/home/profile/website/project/vmp/malwaredb/virus_total/'+ hash, 'wb') as f:
        f.write(json)
        parse_to_xml(hash, json)

## wanna change to parse_to_xml(hash)
def parse_to_xml(hash, json_content):
    # [input] parser-json-xml.py file-hash
    output_dir="/home/profile/website/project/vmp/malwaredb/templates/"

    data = json.loads(json_content)
    fh = None
    try:
        fh = open(output_dir+hash+"_json.html", "w")
        if 'scans' in data:
            fh.write('<table style="width:100%">\n')
            for item in data['scans'].items():
                fh.write('<tr>\n')
                fh.write('<td>' + str(item[0]) + '</td>\n')
                for attr_key, attr_value in item[1].items():
                    #fh.write('<td>' + str(attr_key) + " " + str(attr_value) + '</td>\n')
                    fh.write('<td>' + str(attr_value) + '</td>\n')
                fh.write("</tr>\n")
            fh.write('</table>')
        else:
            fh.write("There's no result")
    finally:
        if fh != None:
            fh.close()   
